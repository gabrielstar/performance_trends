name: $(BuildID)
trigger:
    batch: true
    branches:
      include:
      - '*'
#config
variables:
  flag: default #edit


jobs:
  - job: Run_App
    displayName: CI_CD
    pool:
      vmImage: 'ubuntu-latest'
    timeoutInMinutes: 5
    steps:
    - bash: |
        cd $(System.DefaultWorkingDirectory)/01_api && docker build -t gabrielstar/index.js .
      displayName: Build

    - bash: |
        docker run --name index.js -d --rm -p 3000:3000 gabrielstar/index.js
      displayName: Run

    - pwsh: |
          mkdir -p $(System.DefaultWorkingDirectory)/02_k6/data
          cd $(System.DefaultWorkingDirectory)/02_k6
          echo "Running diagnostics"
          docker run --entrypoint="" -v $(System.DefaultWorkingDirectory)/02_k6/data:/data loadimpact/k6 sh -c "ls -alh && touch /data/foo"
          ls -alh $(System.DefaultWorkingDirectory)/02_k6/data
          cat script.js | `
              docker run -i -v $(System.DefaultWorkingDirectory)/02_k6/data:/data `
                  loadimpact/k6 run `
                      --summary-export=/data/perf-test-results.json `
                      --vus 2 `
                      --tag user=cicd `
                      --out csv=/data/results.csv `
                      --duration 5s -
      displayName: "Performance Tests"